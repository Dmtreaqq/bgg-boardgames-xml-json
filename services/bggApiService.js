import axios from 'axios'
import fs from 'fs/promises'

const someIds =
  '224517,161936,174430,342942,233078,167791,316554,291457,115746,187645,162886,220308,182028,12333,193738,169786,84876,173346,246900,28720,167355,124361,177736,266507,266192,120677,205637,312484,237182,164928,341169,199792,96848,183394,251247,324856,192135,175914,256960,285774,3076,247763,102794,170216,295947,185343,184267,31260,521,295770,314040,255984,221107,284378,205059,276025,161533,126163,366013,2651,244521,216132,284083,35677,266810,164153,125153,209010,182874,55690,253344,124742,230802,28143,200680,191189,72125,157354,201808,25613,159675,229853,317985,231733,110327,171623,62219,121921,68448,279537,264220,93,180263,236457,37111,225694,122515,155821,18602,170042,224517,161936,174430,342942,233078,167791,316554,291457,115746,187645,162886,220308,182028,12333,193738,169786,84876,173346,246900,28720,167355,124361,177736,266507,266192,120677,205637,312484,237182,164928,341169,199792,96848,183394,251247,324856,192135,175914,256960,285774,3076,247763,102794,170216,295947,185343,184267,31260,521,295770,314040,255984,221107,284378,205059,276025,161533,126163,366013,2651,244521,216132,284083,35677,266810,164153,125153,209010,182874,55690,253344,124742,230802,28143,200680,191189,72125,157354,201808,25613,159675,229853,317985,231733,110327,171623,62219,121921,68448,279537,264220,93,180263,236457,37111,225694,122515,155821,18602,170042,224517,161936,174430,342942,233078,167791,316554,291457,115746,187645,162886,220308,182028,12333,193738,169786,84876,173346,246900,28720,167355,124361,177736,266507,266192,120677,205637,312484,237182,164928,341169,199792,96848,183394,251247,324856,192135,175914,256960,285774,3076,247763,102794,170216,295947,185343,184267,31260,521,295770,314040,255984,221107,284378,205059,276025,161533,126163,366013,2651,244521,216132,284083,35677,266810,164153,125153,209010,182874,55690,253344,124742,230802,28143,200680,191189,72125,157354,201808,25613,159675,229853,317985,231733,110327,171623,62219,121921,68448,279537,264220,93,180263,236457,37111,225694,122515,155821,18602,170042'

const BGG_API_URL = 'https://www.boardgamegeek.com/xmlapi'

export const getBoardgamesByIdsXML = async (ids) => {
  try {
    const boardgamesXMLresponse = await axios.get(
      `${BGG_API_URL}/boardgame/${ids}`
    )

    return boardgamesXMLresponse.data
  } catch (err) {
    console.error(
      'Failed to fetch boardgames from BGG API, try later or use less IDs',
      err.message
    )
    return
  }
}

const getNestedIdsArray = (idsString) => {
  const idsArray = idsString.split(',')

  return idsArray.reduce((acc, _, index, array) => {
    if (index % 100 === 0) {
      acc.push(array.slice(index, index + 100))
    }

    return acc
  }, [])
}

export const getBoardgamesByIdsXMLArray = async (ids) => {
  const xmls = []

  const nestedArrayOfIds = getNestedIdsArray(ids)
  const nestedLength = nestedArrayOfIds.length
  const clearedNestedArrayOfIds = nestedArrayOfIds.map((idsArray, index) => {
    if (index === nestedLength - 1) {
      return idsArray.filter(Boolean)
    }

    return idsArray
  })

  for (let i = 0; i < clearedNestedArrayOfIds.length; i++) {
    console.log(`Processing ${i+1}00 games...`)
    const xml = await getBoardgamesByIdsXML(clearedNestedArrayOfIds[i].toString())
    console.log('Request done')
    xmls.push(xml)

    await new Promise(resolve => setTimeout(resolve, 8000));
  }

  return xmls
}
